<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://wangzhengquan.github.io/blog/ProgramingLanguage/assembly/Inline%20assembly%20for%20x86/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.3.9"><title>Inline assembly for x86 - My Blogs</title><link rel=stylesheet href=../../../assets/stylesheets/main.1d29e8d0.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="My Blogs" class="md-header__button md-logo" aria-label="My Blogs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> My Blogs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Inline assembly for x86 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="My Blogs" class="md-nav__button md-logo" aria-label="My Blogs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> My Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> 简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Algorithms <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Algorithms data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Algorithms </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Algorithms/Using_a_Stack_to_Evaluate_an_Expression/ class=md-nav__link> Using a Stack to Evaluate an Expression </a> </li> <li class=md-nav__item> <a href=../../../Algorithms/Using%20two%20stacks%20to%20Evaluate%20an%20Expression/ class=md-nav__link> Using two stacks to Evaluate an Expression </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Shell data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Shell/Shell%20Command/ class=md-nav__link> Shell Command </a> </li> <li class=md-nav__item> <a href=../../../Shell/Shell%20Script/ class=md-nav__link> Shell Script </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> MacOS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=MacOS data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> MacOS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../MacOS/Launching%20Custom%20Daemons%20Using%20launchd/ class=md-nav__link> Launching Custom Daemons Using launchd </a> </li> <li class=md-nav__item> <a href=../../../MacOS/MacOS%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=md-nav__link> MacOS常用命令 </a> </li> <li class=md-nav__item> <a href=../../../MacOS/MacOS%E5%BF%85%E5%A4%87/ class=md-nav__link> MacOS必备 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Unbuntu <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Unbuntu data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Unbuntu </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Unbuntu/fix-the-no-wi-fi-adapter-found-error-on-ubuntu/ class=md-nav__link> Fix “No Wi-Fi Adapter Found” Error on Ubuntu </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Vim <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Vim data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Vim </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Vim/vim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=md-nav__link> Vim常用命令 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> 编辑器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=编辑器 data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> 编辑器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../editor/Sublime/ class=md-nav__link> Sublime </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8> GCC <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=GCC data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> GCC </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../GCC/GCC%20compiling%20processes/ class=md-nav__link> GCC compiling processes </a> </li> <li class=md-nav__item> <a href=../../../GCC/GCC%20Linking/ class=md-nav__link> GCC Linking </a> </li> <li class=md-nav__item> <a href=../../../GCC/Tools%20for%20Manipulating%20Object%20Files/ class=md-nav__link> Tools for Manipulating Object Files </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_9 type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9> GDB <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=GDB data-md-level=1> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> GDB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../GDB/gdb%20demo/ class=md-nav__link> gdb demo </a> </li> <li class=md-nav__item> <a href=../../../GDB/gdbnotes-x86-64.pdf class=md-nav__link> Summary of GDB commands </a> </li> <li class=md-nav__item> <a href=../../../GDB/GDB%20Cheat%20Sheet.pdf class=md-nav__link> GDB Cheat Sheet </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_10 type=checkbox id=__nav_10 checked> <label class=md-nav__link for=__nav_10> 编程语言 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=编程语言 data-md-level=1> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> 编程语言 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_10_1 type=checkbox id=__nav_10_1 checked> <label class=md-nav__link for=__nav_10_1> Assembly <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Assembly data-md-level=2> <label class=md-nav__title for=__nav_10_1> <span class="md-nav__icon md-icon"></span> Assembly </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Inline assembly for x86 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Inline assembly for x86 </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 汇编语言语法简介 </a> </li> <li class=md-nav__item> <a href=#inline-assembly class=md-nav__link> Inline assembly </a> </li> <li class=md-nav__item> <a href=#example class=md-nav__link> Example </a> <nav class=md-nav aria-label=Example> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-register-constraint-r class=md-nav__link> the register constraint "r" </a> </li> <li class=md-nav__item> <a href=#use-of-specific-register-constraints class=md-nav__link> Use of specific register constraints </a> </li> <li class=md-nav__item> <a href=#matching-constraints class=md-nav__link> Matching constraints </a> </li> <li class=md-nav__item> <a href=#use-of-memory-operand-constraint class=md-nav__link> Use of memory operand constraint </a> </li> <li class=md-nav__item> <a href=#using-clobbered-registers class=md-nav__link> Using clobbered registers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> Conclusion </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_10_2 type=checkbox id=__nav_10_2> <label class=md-nav__link for=__nav_10_2> C <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=C data-md-level=2> <label class=md-nav__title for=__nav_10_2> <span class="md-nav__icon md-icon"></span> C </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../C/C_takeaway/ class=md-nav__link> C语言要点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_11 type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11> Markdown <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Markdown data-md-level=1> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Markdown </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Markdown/Markdown%20Syntax/ class=md-nav__link> Markdown Syntax </a> </li> <li class=md-nav__item> <a href=../../../Markdown/Markdown%E6%A8%A1%E7%89%88/ class=md-nav__link> Markdown模版 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_12 type=checkbox id=__nav_12> <label class=md-nav__link for=__nav_12> Git <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Git data-md-level=1> <label class=md-nav__title for=__nav_12> <span class="md-nav__icon md-icon"></span> Git </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Git/Git%20commands/ class=md-nav__link> Git commands </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_13 type=checkbox id=__nav_13> <label class=md-nav__link for=__nav_13> SSH <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=SSH data-md-level=1> <label class=md-nav__title for=__nav_13> <span class="md-nav__icon md-icon"></span> SSH </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../SSH/SSH%20command/ class=md-nav__link> SSH command </a> </li> <li class=md-nav__item> <a href=../../../SSH/SSH%20install/ class=md-nav__link> SSH install </a> </li> <li class=md-nav__item> <a href=../../../SSH/SSH%20login%20without%20password/ class=md-nav__link> SSH login without password </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_14 type=checkbox id=__nav_14> <label class=md-nav__link for=__nav_14> Vagrant <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Vagrant data-md-level=1> <label class=md-nav__title for=__nav_14> <span class="md-nav__icon md-icon"></span> Vagrant </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Vagrant/Vagrant%20tutorial/ class=md-nav__link> Vagrant tutorial </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 汇编语言语法简介 </a> </li> <li class=md-nav__item> <a href=#inline-assembly class=md-nav__link> Inline assembly </a> </li> <li class=md-nav__item> <a href=#example class=md-nav__link> Example </a> <nav class=md-nav aria-label=Example> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-register-constraint-r class=md-nav__link> the register constraint "r" </a> </li> <li class=md-nav__item> <a href=#use-of-specific-register-constraints class=md-nav__link> Use of specific register constraints </a> </li> <li class=md-nav__item> <a href=#matching-constraints class=md-nav__link> Matching constraints </a> </li> <li class=md-nav__item> <a href=#use-of-memory-operand-constraint class=md-nav__link> Use of memory operand constraint </a> </li> <li class=md-nav__item> <a href=#using-clobbered-registers class=md-nav__link> Using clobbered registers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> Conclusion </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Inline assembly for x86</h1> <h2 id=_1>汇编语言语法简介</h2> <p>让我们首先看一下在Linux中使用的基本汇编语言语法。GCC 即 GNU C Compiler 使用的是AT&amp;汇编语言的语法。一些基本的规则介绍如下：（这里列出的当然不是汇编语法的全部，我们只涉及与本次主题相关的规则）</p> <ul> <li> <p>寄存器命名 寄存器的名字都会加一个前缀 % 。 也就是说当eax寄存器被使用到的时候，应该写作%eax。</p> </li> <li> <p>Source 和 destination 的顺序 在任何命令中source是第一个，destination跟在后面。 这和Intel语法是不同的，Intel的语法source跟在destination的后面。</p> </li> </ul> <pre><code> mov %eax, %ebx, transfers the contents of eax to ebx.
</code></pre> <ul> <li>操作符（operand）的大小 根据operand是byte, word 还是 long 类型，这些命令会加一个b, w 或者 l 的后缀。这后缀并不是规定必须的，GCC会尝试给分析操作符并自动提供合适的后缀。但是明确的加上后缀可以提高代码的可读性，消除编译器猜错误的可能性。</li> </ul> <pre><code>movb %al, %bl -- Byte move
movw %ax, %bx -- Word move
movl %eax, %ebx -- Longword move
</code></pre> <ul> <li>Immediate operand 一个immediate operand 前面加一个$符号特殊说明</li> </ul> <pre><code> movl $0xffff, %eax -- will move the value of 0xffff into eax register.
</code></pre> <ul> <li>间接内存引用 间接内存引用是通过使用 ( ) 实现</li> </ul> <pre><code>movb (%esi), %al -- will transfer the byte in the memory 
                     pointed by esi into al  register
</code></pre> <h2 id=inline-assembly>Inline assembly</h2> <p>GCC 为inline assembly 提供了一个特殊的结构体"asm"，它的格式如下：</p> <pre><code> asm ( assembler template
      : list of output varialble       (optional)
      : list of input varialble        (optional)
      : list of clobbered registers       (optional)
      );  
</code></pre> <p>这个结构体的作用是把C代码的表达式(expression)与汇编代码中的操作符（operand）关联起来，可以吧每个关联看作一个变量，这些关联变量在asm结构体中的“list of output varialble”和 “list of input varialble 逗号分隔，从左到右依次用"0", "1", "2"...表示这些变量的索引，关联变量定义的格式如下：</p> <pre><code>&quot;constraint&quot; (expr)
</code></pre> <p>其中左边的constraint是对应变量在汇编代码中的操作符，输出变量的constraint左边还会多加一个“=”表示它是输出变量， 右边的 expr 是对应变量在C代码中的表达式。constraint可以是寄存器也可以是内存。如果一个输出变量的constraint是一个寄存器那么编译器会生成 <code>mov register, expr</code> 的代码，把寄存器的值赋予给expr所代表的C变量上。如果一个输入变量的constraint是一个寄存器那么编译器会生成 <code>mov expr， register</code> 的代码，把expr所代表的C语言的值赋值给寄存器。如果一个输出变量的constraint是一个寄存器那么编译器会生成 <code>mov register, expr</code> 的代码，把寄存器的值赋给expr的C语言变量。</p> <p>constraint中常用的选项及其所代表的含义说明如下：</p> <pre><code>a        eax
b        ebx
c        ecx
d        edx
S        esi
D        edi
I        constant value (0 to 31)
q        dynamically allocated register from eax, ebx, ecx, edx
r            dynamically allocated register from eax, ebx, ecx, edx, esi, edi
g        eax, ebx, ecx, edx or variable in memory
A        eax and edx combined into a 64-bit integer (use long longs)
m        memory refrence
</code></pre> <h2 id=example>Example</h2> <h3 id=the-register-constraint-r>the register constraint "r"</h3> <pre><code>int cr3val;
asm (&quot;movl %%cr3, %0\n&quot; :&quot;=r&quot;(cr3val));
</code></pre> <p>把cr3控制器的内容拷贝到任意分配的一个寄存器上（"=r"），然后把这个寄存器的内容赋值给cr3val。</p> <p>再看一个例子</p> <pre><code>
int main(void)
{
  int x = 10, y;

  asm (&quot;movl %1, %%eax;
       &quot;movl %%eax, %0;&quot;
    :&quot;=r&quot;(y)  /* y is output operand */
    :&quot;r&quot;(x)   /* x is input operand */
    :&quot;%eax&quot;); /* %eax is clobbered register */
}

</code></pre> <p>In this example, the value of x is copied to y inside "asm". x and y are passed to "asm" by being stored in registers. The assembly code generated for this example looks like this:</p> <pre><code>main:
        pushl %ebp
        movl %esp,%ebp
        subl $8,%esp
        movl $10,-4(%ebp)  
        movl -4(%ebp),%edx  /* x=10 is stored in %edx */
#APP  /* asm starts here */ 
        movl %edx, %eax   /* x is moved to %eax */
        movl %eax, %edx   /* y is allocated in edx and updated */

#NO_APP /* asm ends here */
        movl %edx,-8(%ebp)  /* value of y in stack is updated with the value in %edx */ 
</code></pre> <p>GCC is free here to allocate any register when the "r" constraint is used. In our example it chose %edx for storing x. After reading the value of x in %edx, it allocated the same register for y.</p> <p>Since y is specified in the output operand section, the updated value in %edx is stored in -8(%ebp), the location of y on stack. If y were specified in the input section, the value of y on stack would not be updated, even though it does get updated in the temporary register storage of y(%edx).</p> <p>And since %eax is specified in the clobbered list, GCC doesn't use it anywhere else to store data.</p> <p>Both input x and output y were allocated in the same %edx register, assuming that inputs are consumed before outputs are produced. Note that if you have a lot of instructions, this may not be the case. To make sure that input and output are allocated in different registers, we can specify the &amp; constraint modifier. Here is our example with the constraint modifier added.</p> <pre><code> int main(void)
{
  int x = 10, y;

  asm (&quot;movl %1, %%eax;
       &quot;movl %%eax, %0;&quot;
    :&quot;=&amp;r&quot;(y) /* y is output operand, note the &amp; constraint modifier. */
    :&quot;r&quot;(x)   /* x is input operand */
    :&quot;%eax&quot;); /* %eax is clobbered register */
}
</code></pre> <p>And here is the assembly code generated for this example, from which it is evident that x and y have been stored in different registers across "asm".</p> <pre><code>main:
  pushl %ebp
  movl %esp,%ebp
  subl $8,%esp
  movl $10,-4(%ebp)
  movl -4(%ebp),%ecx  /* x, the input is in %ecx */
#APP
  movl %ecx, %eax
  movl %eax, %edx   /* y, the output is in %edx */

#NO_APP
  movl %edx,-8(%ebp)
</code></pre> <h3 id=use-of-specific-register-constraints>Use of specific register constraints</h3> <p>Now let's take a look at how to specify individual registers as constraints for the operands. In the following example, the cpuid instruction takes the input in the %eax register and gives output in four registers: %eax, %ebx, %ecx, %edx. The input to cpuid (the variable "op") is passed to "asm" in the eax register, as cpuid expects it to. The a, b, c, and d constraints are used in the output to collect the values in the four registers, respectively.</p> <pre><code>asm (&quot;cpuid&quot;
                : &quot;=a&quot; (_eax),
                  &quot;=b&quot; (_ebx),
                  &quot;=c&quot; (_ecx),
                  &quot;=d&quot; (_edx)
                : &quot;a&quot; (op));

</code></pre> <p>And below you can see the generated assembly code for this (assuming the _eax, _ebx, etc.... variables are stored on stack):</p> <pre><code>movl -20(%ebp),%eax /* store 'op' in %eax -- input */
#APP
        cpuid
#NO_APP
        movl %eax,-4(%ebp)  /* store %eax in _eax -- output */
        movl %ebx,-8(%ebp)  /* store other registers in
        movl %ecx,-12(%ebp)    respective output variables */  
        movl %edx,-16(%ebp)
</code></pre> <p>The strcpy function can be implemented using the "S" and "D" constraints in the following manner:</p> <pre><code> asm (&quot;cld\n
        rep\n
        movsb&quot;
        : /* no input */
        :&quot;S&quot;(src), &quot;D&quot;(dst), &quot;c&quot;(count));
</code></pre> <p>The source pointer src is put into %esi by using the "S" constraint, and the destination pointer dst is put into %edi using the "D" constraint. The count value is put into %ecx as it is needed by rep prefix.</p> <p>And here you can see another constraint that uses the two registers %eax and %edx to combine two 32-bit values and generate a 64-bit value:</p> <pre><code>#define rdtscll(val) \
     __asm__ __volatile__ (&quot;rdtsc&quot; : &quot;=A&quot; (val))

The generated assembly looks like this (if val has a 64 bit memory space).

#APP
        rdtsc
#NO_APP
        movl %eax,-8(%ebp)  /* As a result of A constraint 
        movl %edx,-4(%ebp)     %eax and %edx serve as outputs */

Note here that the values in %edx:%eax serve as 64 bit output.
</code></pre> <h3 id=matching-constraints>Matching constraints</h3> <p>In some cases, a single variable may serve as both the input and the output operand. Such cases may be specified in "asm" by using matching constraints.</p> <pre><code>asm (&quot;incl %0&quot; :&quot;=a&quot;(var):&quot;0&quot;(var));
</code></pre> <p>In our example for matching constraints, the register %eax is used as both the input and the output variable. var input is read to %eax and updated %eax is stored in var again after increment. "0" here specifies the same constraint as the 0th output variable. That is, it specifies that the output instance of var should be stored in %eax only. This constraint can be used:</p> <ul> <li>In cases where input is read from a variable or the variable is modified and modification is written back to the same variable</li> <li>In cases where separate instances of input and output operands are not necessary</li> </ul> <p>The most important effect of using matching restraints is that they lead to the efficient use of available registers.</p> <p>Here you can see another example for the system call, with four parameters:</p> <pre><code>#define _syscall4(type,name,type1,arg1,type2,arg2,type3,arg3,type4,arg4) \
type name (type1 arg1, type2 arg2, type3 arg3, type4 arg4) \
{ \
long __res; \
__asm__ volatile (&quot;int $0x80&quot; \
        : &quot;=a&quot; (__res) \
        : &quot;0&quot; (__NR_##name),&quot;b&quot; ((long)(arg1)),&quot;c&quot; ((long)(arg2)), \
          &quot;d&quot; ((long)(arg3)),&quot;S&quot; ((long)(arg4))); \
__syscall_return(type,__res); \
}
</code></pre> <p>In the above example, four arguments to the system call are put into %ebx, %ecx, %edx, and %esi by using the constraints b, c, d, and S. Note that the "=a" constraint is used in the output so that the return value of the system call, which is in %eax, is put into the variable __res. By using the matching constraint "0" as the first operand constraint in the input section, the syscall number __NR_##name is put into %eax and serves as the input to the system call. Thus %eax serves here as both input and output register. No separate registers are used for this purpose. Note also that the input (syscall number) is consumed (used) before the output (the return value of syscall) is produced.</p> <h3 id=use-of-memory-operand-constraint>Use of memory operand constraint</h3> <p>When the operands are in the memory, any operations performed on them will occur directly in the memory location, as opposed to register constraints, which first store the value in a register to be modified and then write it back to the memory location. But register constraints are usually used only when they are absolutely necessary for an instruction or they significantly speed up the process. Memory constraints can be used most efficiently in cases where a C variable needs to be updated inside "asm" and you really don't want to use a register to hold its value. For example, the value of idtr is stored in the memory location loc:</p> <pre><code>asm (&quot;sidt %0\n&quot; : :&quot;m&quot;(loc));
</code></pre> <p>Another example,Consider the following atomic decrement operation:</p> <pre><code> __asm__ __volatile__(
                &quot;lock; decl %0&quot;
                :&quot;=m&quot; (counter)
                :&quot;m&quot; (counter));
</code></pre> <p>The generated assembly for this would look something like this:</p> <pre><code>#APP
  lock
  decl -24(%ebp) /* counter is modified on its memory location */
#NO_APP.
</code></pre> <p>You might think of using the register constraint here for the counter. If you do, the value of the counter must first be copied on to a register, decremented, and then updated to its memory. But then you lose the whole purpose of locking and atomicity, which clearly shows the necessity of using the memory constraint.</p> <h3 id=using-clobbered-registers>Using clobbered registers</h3> <p>Consider an elementary implementation of memory copy.</p> <pre><code> asm (&quot;movl $count, %%ecx;
        up: lodsl;  
        stosl;
        loop up;&quot;
    :       /* no output */
    :&quot;S&quot;(src), &quot;D&quot;(dst) /* input */
    :&quot;%ecx&quot;, &quot;%eax&quot; );  /* clobbered list */  
</code></pre> <p>While lodsl modifies %eax, the lodsl and stosl instructions use it implicitly. And the %ecx register explicitly loads the count. But GCC won't know this unless we inform it, which is exactly what we do by including %eax and %ecx in the clobbered register set. Unless this is done, GCC assumes that %eax and %ecx are free, and it may decide to use them for storing other data. Note here that %esi and %edi are used by "asm", and are not in the clobbered list. This is because it has been declared that "asm" will use them in the input operand list. The bottom line here is that if a register is used inside "asm" (implicitly or explicitly), and it is not present in either the input or output operand list, you must list it as a clobbered register.</p> <p>If you write to a variable, you must include "memory" as one of The Clobbered. This is in case you wrote to a variable that GCC thought it had in a register. This is the same as clobbering all registers. While I've never run into a problem with it, you might also want to add "cc" as a clobber if you change the condition codes (the bits in the flags register the jnz, je, etc. operators look at.)</p> <h2 id=conclusion>Conclusion</h2> <p>On the whole, inline assembly is huge and provides a lot of features that we did not even touch on here. But with a basic grasp of the material in this article, you should be able to start coding inline assembly on your own.</p> <p>Reference:</p> <blockquote> <p>https://www.cristal.univ-lille.fr/~marquet/ens/ctx/doc/l-ia.html http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html</p> </blockquote> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../../GDB/GDB%20Cheat%20Sheet.pdf class="md-footer__link md-footer__link--prev" aria-label="Previous: GDB Cheat Sheet" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> GDB Cheat Sheet </div> </div> </a> <a href=../../C/C_takeaway/ class="md-footer__link md-footer__link--next" aria-label="Next: C语言要点" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> C语言要点 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.6c7ad80a.min.js></script> </body> </html>